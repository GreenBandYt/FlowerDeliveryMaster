from telegram import Update
from telegram.ext import CallbackContext
from prettytable import PrettyTable
from catalog.models import Order
from users.models import CustomUser
import logging

# Настройка логгера
logger = logging.getLogger(__name__)

def view_orders(update: Update, context: CallbackContext):
    """
    Отображение истории заказов клиента.
    """
    user = update.effective_user

    try:
        logger.info(f"Пользователь {user.username} ({user.id}) отправил команду /view_orders")

        # Проверяем наличие пользователя в базе данных
        custom_user = CustomUser.objects.filter(telegram_id=user.id).first()
        if not custom_user:
            logger.warning(f"Пользователь с telegram_id={user.id} не найден в базе данных.")
            update.message.reply_text(
                "Ваш аккаунт не зарегистрирован. Пожалуйста, зарегистрируйтесь для просмотра заказов."
            )
            return

        # Получаем заказы пользователя
        orders = Order.objects.filter(user=custom_user).order_by('-created_at')
        logger.info(f"Найдено {len(orders)} заказов для пользователя {user.id}")

        if not orders:
            logger.info(f"У пользователя {user.username} ({user.id}) нет заказов.")
            update.message.reply_text("У вас пока нет заказов.")
            return

        # Создаем таблицу с помощью PrettyTable
        table = PrettyTable()
        table.field_names = ["ID заказа", "Дата", "Статус", "Сумма"]
        table.align["ID заказа"] = "l"
        table.align["Дата"] = "l"
        table.align["Статус"] = "l"
        table.align["Сумма"] = "r"

        for order in orders:
            table.add_row([
                order.id,
                order.created_at.strftime("%Y-%m-%d %H:%M"),
                order.get_status_display(),
                f"{order.total_price:.2f} руб.",
            ])

        # Разбиваем сообщение, если оно слишком длинное
        table_str = table.get_string()
        max_message_length = 4000
        if len(table_str) > max_message_length:
            chunks = [table_str[i:i + max_message_length] for i in range(0, len(table_str), max_message_length)]
            for chunk in chunks:
                update.message.reply_text(f"```\n{chunk}\n```", parse_mode="Markdown")
        else:
            update.message.reply_text(f"Ваши заказы:\n```\n{table}\n```", parse_mode="Markdown")

        logger.info(f"Таблица заказов для пользователя {user.username} ({user.id}) успешно создана.")

    except Exception as e:
        logger.error(f"Ошибка при обработке команды /view_orders для пользователя {user.username} ({user.id}): {e}", exc_info=True)
        update.message.reply_text("Произошла ошибка при получении заказов.")
